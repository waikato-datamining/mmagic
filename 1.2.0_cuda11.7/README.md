# MMagic

Command-line utilities for using MMagic. 

Uses MMagic 1.2.0 (c749dcc7172d198ac2a27c3e5a4d2181640f0fd5), CUDA 11.7 and torch 2.0.1.


## Quick start

### Inhouse registry

* Log into registry with the appropriate credentials:

  ```bash
  docker login -u public -p public public.aml-repo.cms.waikato.ac.nz:443 
  ```

* Pull and run image (adjust volume mappings `-v`):

  ```bash
  docker run \
    --gpus=all --shm-size 8G \
    -v /local/dir:/container/dir \
    -it public.aml-repo.cms.waikato.ac.nz:443/open-mmlab/mmagic:1.2.0_cuda11.7
  ```

### Docker hub

* Pull and run image (adjust volume mappings `-v`):

  ```bash
  docker run --gpus=all --shm-size 8G \
    -v /local/dir:/container/dir \
    -it waikatodatamining/mmagic:1.2.0_cuda11.7
  ```

### Build local image

* Build the image from Docker file (from within `/path_to/1.2.0_cuda11.7`)

  ```bash
  docker build -t mmagic .
  ```
  
* Run the container

  ```bash
  docker run \
    --gpus=all --shm-size 8G \
    -v /local/dir:/container/dir -it mmagic
  ```
  `/local/dir:/container/dir` maps a local disk directory into a directory inside the container


## Publish images

### Build

```bash
docker build -t mmagic:1.2.0_cuda11.7 .
```

### Inhouse registry  

* Tag

  ```bash
  docker tag \
    mmagic:1.2.0_cuda11.7 \
    public-push.aml-repo.cms.waikato.ac.nz:443/open-mmlab/mmagic:1.2.0_cuda11.7
  ```
  
* Push

  ```bash
  docker push public-push.aml-repo.cms.waikato.ac.nz:443/open-mmlab/mmagic:1.2.0_cuda11.7
  ```
  If error "no basic auth credentials" occurs, then run (enter username/password when prompted):
  
  ```bash
  docker login public-push.aml-repo.cms.waikato.ac.nz:443
  ```

### Docker hub  

* Tag

  ```bash
  docker tag \
    mmagic:1.2.0_cuda11.7 \
    waikatodatamining/mmagic:1.2.0_cuda11.7
  ```
  
* Push

  ```bash
  docker push waikatodatamining/mmagic:1.2.0_cuda11.7
  ```
  If error "no basic auth credentials" occurs, then run (enter username/password when prompted):
  
  ```bash
  docker login
  ``` 

## Permissions

When running the docker container as regular use, you will want to set the correct
user and group on the files generated by the container (aka the user:group launching
the container):

```bash
docker run -u $(id -u):$(id -g) -e USER=$USER ...
```

## Scripts

The following additional scripts are available:

* `mmagic_inference_demo` - calls the `/opt/mmagic/demo/mmagic_inference_demo.py` 
  script (NB: changes into the `/opt/mmagic` directory first, for the config paths to work)


## Examples

See the MMagic documentation for some examples:

https://github.com/open-mmlab/mmagic/blob/v1.0.1/docs/en/get_started/quick_run.md
